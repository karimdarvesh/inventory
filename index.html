<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Supabase Inventory Manager (Light Premium)</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f7fafd;
      color: #21243a;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 900px;
      margin: 36px auto;
      padding: 30px 4vw 32px 4vw;
      background: #fff;
      border-radius: 19px;
      box-shadow: 0 6px 40px #e4ecfc99, 0 1px 0 #f5f7fb;
      border: 1.5px solid #e2e8f7;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 20px 10px;
      margin-bottom: 22px;
    }
    .app-title {
      font-size: 2.15rem;
      font-weight: 700;
      letter-spacing: 1px;
      flex: 1;
      min-width: 210px;
      color: #224198;
      text-shadow: 0 2px 12px #e2eaef73;
    }
    .export-btn {
      background: linear-gradient(90deg,#79b3f7,#bfe9ff);
      color:#184e77;
      font-weight:700;
      padding:10px 22px;
      border-radius:10px;
      border:none;
      margin-left:10px;
      margin-top:5px;
      box-shadow:0 2px 10px #e4ecfc33;
      transition:background .18s, box-shadow .18s;
      font-size: 1rem;
    }
    .export-btn:hover { background: linear-gradient(90deg,#67d8c2,#e0c3fc); color:#185353; }
    form#searchform {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 13px 8px;
      margin-bottom: 22px;
      background: #f2f7ff;
      padding: 13px 14px 11px 14px;
      border-radius: 11px;
      box-shadow:0 2px 8px #e4ecfc22;
    }
    input#search, input#username {
      border-radius: 7px;
      border: 1.5px solid #d0def5;
      font-size: 1rem;
      padding: 10px;
      min-width: 140px;
      flex: 1;
      box-sizing: border-box;
      background: #fefdff;
      color: #224198;
    }
    input#search { min-width: 190px; max-width: 340px; }
    input#username { min-width: 100px; max-width: 160px; }
    button, input { outline: none; }
    button {
      background: #48ccb1;
      color: #fff;
      font-weight: 600;
      border-radius: 7px;
      border: none;
      padding: 10px 22px;
      font-size: 1rem;
      transition: background .18s;
    }
    button:hover { background:#3e9f95;}
    .voice-btn { background:#2494bd !important; color:#fff !important; font-size:19px; padding: 9px 13px;}
    .modal {
      display:none;
      position:fixed;
      left:0; top:0; right:0; bottom:0;
      background:rgba(16,32,54,0.09); z-index:99;
    }
    .modal-inner {
      max-width:98vw;
      margin:60px auto;
      background: #fafdff;
      border-radius:19px;
      border:1.5px solid #dbeafe;
      box-shadow:0 8px 32px #e8ecf0ec;
      padding:26px 4vw 20px 4vw;
      max-height:85vh;
      overflow-y:auto;
    }
    #modal-list {
      margin-bottom:20px;
      max-height:70vh;
      overflow-y:auto;
    }
    .modal-row {
      background: #f4f9ff;
      border-radius:13px;
      box-shadow:0 2px 11px #accedc18;
      margin-bottom:18px;
      padding: 18px 9px;
      border-left:5px solid #86cafe;
      border-right:3px solid #c2f7fa;
    }
    .modal-row:last-child { margin-bottom:0;}
    .qty-badge, .physical-badge, .diff-badge {
      display:inline-block;
      margin-right:10px;
      font-size: 97%;
      letter-spacing:.4px;
      margin-bottom:6px;
    }
    .qty-badge { background:#b9e7fa; color:#22577e; padding:3px 16px; border-radius:8px; font-weight:700;}
    .physical-badge { background:#d7fce6; color:#206648; padding:3px 16px; border-radius:8px; font-weight:700;}
    .diff-badge { background:#ffe9b4; color:#b98500; padding:3px 16px; border-radius:8px; font-weight:700;}
    .modal-row label { font-size:15px; margin-right:4px;}
    .modal-row input.qty-inp { width:88px; font-size:15px; border-radius:7px; padding:6px 6px; border:1.2px solid #d0def5; background:#fcfeff;}
    .modal-row .row-btn { padding:6px 13px; margin-right:6px; font-size:1em; background:linear-gradient(90deg,#4eadcc,#67e8f9); color:#fff; }
    .modal-row .row-btn:hover {background:linear-gradient(90deg,#67e8f9,#be70f5);}
    .modal-row .voice-btn { font-size:17px; padding:6px 9px;}
    .close-btn { background: #ecf1f7; color: #375d7a; font-weight:700; float:right; border-radius:9px; margin-top:6px; padding:6px 18px; border:1.1px solid #bfd5f7;}
    #export-range {margin-left:18px; color:#4eadcc; font-size:15px; margin-top:4px; font-weight:600;}
    @media (max-width:560px) {
      .container { padding: 10px 2vw; }
      header, form#searchform { flex-direction:column; align-items:stretch; gap: 8px; }
      .modal-inner { max-width: 99vw; padding: 10px 2vw; }
      .modal-row { padding: 12px 4px;}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <span class="app-title">Supabase Inventory Manager</span>
      <button class="export-btn" onclick="exportToCSV()">Export Sheet as CSV</button>
      <span id="export-range"></span>
    </header>
    <form id="searchform" onsubmit="searchInventory(); return false;">
      <input id="search" placeholder="Article name or part..." autocomplete="off">
      <button type="submit">Search</button>
      <button type="button" class="voice-btn" onclick="voiceSearch()">ðŸŽ¤</button>
      <label for="username">Your Name:</label>
      <input id="username" type="text" autocomplete="off" placeholder="Enter once">
    </form>

    <!-- Modal for search results -->
    <div class="modal" id="modal-results">
      <div class="modal-inner">
        <h3 style="margin-top:0;font-weight:600;letter-spacing:0.5px;">Search Results</h3>
        <div id="modal-list"></div>
        <button class="close-btn" onclick="closeModal()" style="margin-top:11px;">Close</button>
      </div>
    </div>
  </div>
  <script>
    const SUPABASE_URL = 'https://yyzakmmxeqxkjbbzjoua.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5emFrbW14ZXF4a2piYnpqb3VhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwODg5NjYsImV4cCI6MjA3ODY2NDk2Nn0.9zs9A7F955gRsSfN-A8hTziMbQ6WEY0YwtVByq12zRQ';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentRows = [];
    let totalInventoryRows = 0;

    document.getElementById('username').value = localStorage.getItem('inventory_user_name') || '';
    document.getElementById('username').onchange = function() {
      localStorage.setItem('inventory_user_name', this.value.trim());
    }
    function getName() {
      const box = document.getElementById('username');
      let v = box.value.trim();
      if (!v) v = localStorage.getItem('inventory_user_name') || "";
      box.value = v;
      return v;
    }
    async function searchInventory() {
      const q = document.getElementById('search').value.trim();
      let query = supabase.from('inventory').select('*');
      if (q.length) query = query.ilike('article_name', `%${q}%`);
      const { data: items, error } = await query.order('id');
      if (error) return alert(error.message);
      currentRows = items || [];
      showModal(currentRows);
    }
    function closeModal() { document.getElementById('modal-results').style.display = 'none'; }
    function voiceSearch() {
      if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
        alert('Voice input not supported!');
        return;
      }
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recog = new SR();
      recog.lang = 'en-US';
      recog.interimResults = false; recog.maxAlternatives=1;
      recog.onresult = async evt => {
        const t = String(evt.results[0][0].transcript||'').trim();
        document.getElementById('search').value = t;
        await searchInventory();
      };
      recog.onerror = e => { alert('Voice error: '+e.error); };
      recog.start();
    }
    // Number extractor: picks first number from a value ("123 PC" -> 123)
    function extractNumber(val) {
      if (val === undefined || val === null) return null;
      let s = String(val);
      let match = s.match(/-?\d+(\.\d+)?/);
      return match ? Number(match[0]) : null;
    }
    function showModal(items) {
      const modal = document.getElementById('modal-results');
      const mlist = document.getElementById('modal-list');
      if (!items.length) { mlist.innerHTML = '<b>No matches found.</b>'; modal.style.display = 'block'; return; }
      mlist.innerHTML = items.map((item,i)=>{
        let qtyDisplay = (item.qty === undefined || item.qty === null || item.qty === "" || item.qty === "null") ? '-' : item.qty;
        let physicalDisplay = (item.physical === undefined || item.physical === null || item.physical === "" || item.physical === "null") ? '-' : item.physical;
        let qtyNum = extractNumber(item.qty);
        let physicalNum = extractNumber(item.physical);
        let diffStr = '-';
        if (qtyNum !== null && physicalNum !== null) {
          diffStr = (physicalNum - qtyNum).toString();
        }
        return `
        <div class="modal-row" id="modal-row-${item.id}">
          <b style="font-size:1.05em;">${item.article_name}</b><br>
          <span class="qty-badge">System: ${qtyDisplay}</span>
          <span class="physical-badge">Physical: ${physicalDisplay}</span>
          <span class="diff-badge">Difference: ${diffStr}</span>
          <div style="margin-top:10px;">
            <button class="row-btn" onclick="markOK(${item.id}, '${qtyDisplay}', ${i})">OK</button>
            <label>Or enter:</label>
            <input class="qty-inp" id="qty-inp-${item.id}" placeholder="Physical qty">
            <button class="voice-btn" onclick="voiceQty(${item.id})" title="Voice input">ðŸŽ¤</button>
            <button class="row-btn" onclick="updateQty(${item.id}, ${i})">Update</button>
          </div>
          <span style="font-size:13px;color:#856;">Checked By: ${item.checked_by||'-'} | Checked At: ${item.checked_at||'-'}</span>
        </div>
      `}).join('');
      modal.style.display = 'block';
    }
    async function markOK(id, qtyValue, idx) {
      const name = getName();
      if (!name) { alert('Enter your name first'); return; }
      const checkedAt = new Date().toISOString();
      const { error: updateErr } = await supabase.from('inventory')
        .update({ 
          physical: qtyValue, 
          difference: 0, 
          checked_by: name, 
          checked_at: checkedAt 
        })
        .eq('id', id);
      if (updateErr) {
        alert('Failed to update: ' + updateErr.message);
        return;
      }
      markDoneRow(id, `Physical set to ${qtyValue}, Difference: 0`);
      setTimeout(() => { closeModal(); }, 700);
    }
    async function updateQty(id, idx) {
      const name = getName();
      if (!name) { alert('Enter your name first'); return; }
      const checkedAt = new Date().toISOString();
      const val = document.getElementById('qty-inp-'+id).value.trim();
      if (!val || isNaN(Number(val))) { alert('Enter physical qty (number)'); return; }
      const { data, error } = await supabase.from('inventory').select('qty').eq('id', id);
      let sysQtyRaw = data && data.length ? data[0].qty : 0;
      let sysQty = extractNumber(sysQtyRaw);
      let diff = Number(val) - (sysQty === null ? 0 : sysQty);
      const { error: updateErr } = await supabase.from('inventory')
        .update({
          physical: val,
          difference: diff,
          checked_by: name,
          checked_at: checkedAt
        })
        .eq('id', id);
      if (updateErr) {
        alert('Failed to update: ' + updateErr.message);
        return;
      }
      markDoneRow(id, `Physical: ${val}, Difference: ${diff}`);
      setTimeout(() => { closeModal(); }, 700);
    }
    function voiceQty(id) {
      if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
        alert('Voice input not supported!');
        return;
      }
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recog = new SR();
      recog.lang = 'en-US';
      recog.interimResults = false; recog.maxAlternatives=1;
      recog.onresult = evt => {
        const t = String(evt.results[0][0].transcript||'').trim();
        document.getElementById('qty-inp-'+id).value = t;
      };
      recog.onerror = e => { alert('Voice error: '+e.error); };
      recog.start();
    }
    function markDoneRow(id, msg) {
      const row = document.getElementById('modal-row-'+id);
      if (row) row.innerHTML += `<div style="color:#43ad97;font-weight:bold;margin-top:7px;">${msg}</div>`;
      setTimeout(()=>{ if(row) row.style.opacity=0.5; }, 700);
    }

    // Export all rows (not filtered), difference = Excel formula as always
    async function exportToCSV() {
      const { data: rows, error } = await supabase.from('inventory').select('*').order('id');
      if (error || !rows || !rows.length) return alert("No data to export!");
      const header = ["id","article_name","qty","physical","difference","checked_by","checked_at"];
      const csvRows = [header];
      for (let i=0; i<rows.length; ++i) {
        const r = rows[i];
        // Excel formula for difference (columns C and D; 1-based plus header)
        const diffFormula = `=D${i+2}-C${i+2}`;
        csvRows.push([r.id, r.article_name, r.qty, r.physical, diffFormula, r.checked_by, r.checked_at].map(v => `"${String(v??'').replace(/"/g,'""')}"`));
      }
      let csv = csvRows.map(r => r.join(',')).join('\n');
      const blob = new Blob([csv], {type: "text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "inventory_export.csv";
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    supabase
      .channel('public:inventory')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'inventory' }, payload=>{})
      .subscribe();

    (async function(){
      const {data} = await supabase.from('inventory').select('*');
      totalInventoryRows = data ? data.length : 0;
    })();
  </script>
</body>
</html>
