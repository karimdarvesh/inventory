<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Supabase Inventory Manager (Table View)</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f7fafd;
      color: #21243a;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 1200px;
      margin: 32px auto;
      padding: 28px 2vw 28px 2vw;
      background: #fff;
      border-radius: 19px;
      box-shadow: 0 6px 36px #e4ecfc99, 0 1px 0 #f5f7fb;
      border: 1.5px solid #e2e8f7;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 18px 10px;
      margin-bottom: 17px;
    }
    .app-title {
      font-size: 2.11rem;
      font-weight: 700;
      letter-spacing: 1px;
      flex: 1;
      min-width: 210px;
      color: #224198;
      text-shadow: 0 2px 12px #e2eaef73;
    }
    .export-btn {
      background: linear-gradient(90deg,#79b3f7,#bfe9ff);
      color:#184e77;
      font-weight:700;
      padding:10px 18px;
      border-radius:9px;
      border:none;
      margin-left:8px;
      font-size: 1rem;
      transition:background .18s;
    }
    .export-btn:hover { background: linear-gradient(90deg,#67d8c2,#e0c3fc); color:#185353; }
    .table-filters-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 13px;
      flex-wrap: wrap;
    }
    .table-filters label {
      font-weight: 600;
      margin-right: 7px;
    }
    #search { min-width:120px; font-size:1rem; border-radius:7px; border: 1.2px solid #cbd5ee; padding:8px 14px;}
    #username { min-width:90px; max-width:160px; padding:8px; border-radius:7px; border:1.2px solid #cbd5ee;}
    .diff-filters {display:flex; gap:6px;}
    .diff-filters button {
      padding: 7px 16px;
      font-size:1em;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      background: #e9eefb;
      color: #284c79;
      cursor:pointer;
      transition: box-shadow .16s, background .17s;
    }
    .diff-filters .active { background: #4eadcc; color: #fff; }
    .diff-filters .diff-lt0 { background: #ffb3b3; color:#971d1d;}
    .diff-filters .diff-gt0 { background: #d3fcd3; color:#16642a;}
    .diff-filters .diff-eq0 { background: #faf089; color: #9d7500;}
    .inv-table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow:0 1px 11px #c3e7fc25;
    }
    .inv-table th,
    .inv-table td {
      padding: 8px 6px;
      text-align: center;
      border-bottom: 1px solid #ecf4fc;
      font-size: 1.02em;
    }
    .inv-table th { background: #f6fafd; font-weight: 700;}
    .inv-table tr:last-child td { border-bottom: none;}
    .bulk-select { transform: scale(1.18); margin:0 4px; }
    .qty-badge { background:#b9e7fa; color:#22577e; padding:2px 10px; border-radius:7px; font-weight:700;}
    .physical-badge { background:#d7fce6; color:#206648; padding:2px 10px; border-radius:7px; font-weight:700;}
    .diff-badge { background:#ffe9b4; color:#b98500; padding:2px 10px; border-radius:7px; font-weight:700;}
    .diff-badge.negative { background:#ff6f6f; color:#fff; }
    .diff-badge.positive { background:#17c47d; color:#fff; }
    .row-btn { padding:6px 12px; border-radius:7px; border:none; font-weight:600; background:linear-gradient(90deg,#4eadcc,#67e8f9); color:#fff; transition:background .14s;}
    .row-btn:hover {background:linear-gradient(90deg,#67e8f9,#be70f5);}
    .bulk-update-btn {
      background: #1ea7b5;
      color: #fff;
      padding: 14px 0;
      margin: 18px auto 3px auto;
      font-size:1.11rem;
      font-weight:700;
      border-radius: 12px;
      border: none;
      width: 100%;
      cursor: pointer;
      box-shadow: 0 1px 10px #c2fdf8;
      text-align: center;
      display: block;
      transition: background .14s;
    }
    .bulk-update-btn:hover {
      background:#43ad97;
    }
    .success-msg { color:#22b87e; font-weight:bold; font-size:1.05em;}
    @media (max-width:900px) {
      .inv-table th, .inv-table td { font-size: .97em; padding:6px 2px;}
    }
    @media (max-width:600px) {
      .container { padding: 10px 1vw;}
      .inv-table th,.inv-table td { font-size:.92em;}
      .table-filters-row { flex-direction:column; gap:7px;}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <span class="app-title">Supabase Inventory Manager</span>
      <button class="export-btn" onclick="exportToCSV()">Export Sheet as CSV</button>
    </header>
    <div class="table-filters-row">
      <div>
        <label>Search: <input id="search" autocomplete="off" placeholder="Article/name/part"></label>
        <label style="margin-left:14px;">Your Name: <input id="username" autocomplete="off" placeholder="Enter once"></label>
      </div>
      <div class="diff-filters" id="diff-filter-btns"></div>
      <button class="bulk-update-btn" onclick="bulkConfirmSelected()">Confirm/Update Selected</button>
    </div>
    <div id="success-message" class="success-msg"></div>
    <table class="inv-table" id="inventory-table">
      <thead>
        <tr>
          <th></th>
          <th>Article Name</th>
          <th>System</th>
          <th>Physical</th>
          <th>Difference</th>
          <th>Checked By</th>
          <th>Checked At</th>
          <th style="min-width:110px;">Actions</th>
        </tr>
      </thead>
      <tbody id="inventory-tbody"></tbody>
    </table>
  </div>
  <script>
    const SUPABASE_URL = 'https://yyzakmmxeqxkjbbzjoua.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5emFrbW14ZXF4a2piYnpqb3VhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwODg5NjYsImV4cCI6MjA3ODY2NDk2Nn0.9zs9A7F955gRsSfN-A8hTziMbQ6WEY0YwtVByq12zRQ';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let rows = [];
    let currentDiffFilter = 'all';
    let searchStr = "";
    let successTimeout = null;

    document.getElementById('username').value = localStorage.getItem('inventory_user_name') || '';
    document.getElementById('username').onchange = function() {
      localStorage.setItem('inventory_user_name', this.value.trim());
    }
    document.getElementById('search').addEventListener('input', e => {
      searchStr = e.target.value.trim();
      renderTable();
    });

    function extractNumber(val) {
      if (val === undefined || val === null) return null;
      let s = String(val);
      let match = s.match(/-?\d+(\.\d+)?/);
      return match ? Number(match[0]) : null;
    }
    function getDifference(qty, physical) {
      let qtyNum = extractNumber(qty);
      let physicalNum = extractNumber(physical);
      if (qtyNum !== null && physicalNum !== null) {
        return physicalNum - qtyNum;
      }
      return null;
    }
    function renderDiffFilters() {
      const btns = [
        { key:'all', label:'All', class:'' },
        { key:'lt0', label:'Difference < 0', class:'diff-lt0' },
        { key:'eq0', label:'Difference = 0', class:'diff-eq0' },
        { key:'gt0', label:'Difference > 0', class:'diff-gt0' }
      ];
      const container = document.getElementById('diff-filter-btns');
      container.innerHTML = btns.map(b=>
        `<button onclick="setDiffFilter('${b.key}')" class="${b.class} ${(currentDiffFilter===b.key?'active':'')}">${b.label}</button>`
      ).join('');
    }
    function setDiffFilter(val) {
      currentDiffFilter = val;
      renderTable();
    }
    function renderTable() {
      renderDiffFilters();
      const tbody = document.getElementById('inventory-tbody');
      let filtered = rows.slice();
      if (searchStr.length) {
        const lowSearch = searchStr.toLowerCase();
        filtered = filtered.filter(r =>
          (r.article_name||"").toLowerCase().includes(lowSearch)
        );
      }
      filtered = filtered.filter(item=>{
        let qtyNum = extractNumber(item.qty);
        let physicalNum = extractNumber(item.physical);
        if (qtyNum === null || physicalNum === null) return currentDiffFilter==='all';
        let diff = physicalNum - qtyNum;
        if (currentDiffFilter==='lt0') return diff < 0;
        if (currentDiffFilter==='gt0') return diff > 0;
        if (currentDiffFilter==='eq0') return diff === 0;
        return true;
      });
      if (!filtered.length) { tbody.innerHTML = '<tr><td colspan="8">No matches found.</td></tr>'; return; }
      tbody.innerHTML = filtered.map(item=>{
        let qtyDisp = (item.qty===undefined || item.qty===null || item.qty==="") ? '-' : item.qty;
        let physDisp = (item.physical===undefined || item.physical===null || item.physical==="") ? '-' : item.physical;
        let diffVal = getDifference(item.qty, item.physical);
        let diffStr = (diffVal!==null) ? diffVal.toString() : '-';
        let diffClass = "";
        if (diffVal<0) diffClass = "negative";
        else if (diffVal>0) diffClass = "positive";
        else if (diffVal===0) diffClass = "";
        return `
          <tr id="row-${item.id}">
            <td><input type="checkbox" class="bulk-select" id="bulk-${item.id}"></td>
            <td>${item.article_name||""}</td>
            <td><span class="qty-badge">${qtyDisp}</span></td>
            <td>
              <span class="physical-badge">${physDisp}</span>
              <input class="qty-inp" id="qty-inp-${item.id}" style="width:70px;margin-left:5px;" placeholder="Update...">
            </td>
            <td><span class="diff-badge ${diffClass}">${diffStr}</span></td>
            <td>${item.checked_by||"-"}</td>
            <td>${item.checked_at||"-"}</td>
            <td>
              <button class="row-btn" onclick="markOK(${item.id},'${qtyDisp}')">OK</button>
              <button class="row-btn" onclick="updateQty(${item.id})" style="background:#3275f5;margin-left:5px;">Update</button>
            </td>
          </tr>
        `;
      }).join('');
    }
    async function fetchRows() {
      const { data, error } = await supabase.from('inventory').select('*').order('id');
      if (error) return alert("Error loading inventory: " + error.message);
      rows = data || [];
      renderTable();
    }
    async function markOK(id, qtyValue) {
      const name = document.getElementById('username').value.trim() || localStorage.getItem('inventory_user_name') || '';
      if (!name) return alert('Enter your name first');
      const checkedAt = new Date().toISOString();
      const { error } = await supabase.from('inventory')
        .update({
          physical: qtyValue,
          difference: 0,
          checked_by: name,
          checked_at: checkedAt
        })
        .eq('id', id);
      if (error) return alert("Failed: "+error.message);
      showSuccess("OK updated.");
      fetchRows();
    }
    async function updateQty(id) {
      const name = document.getElementById('username').value.trim() || localStorage.getItem('inventory_user_name') || '';
      if (!name) return alert('Enter your name first');
      const checkedAt = new Date().toISOString();
      const val = document.getElementById('qty-inp-'+id).value.trim();
      if (!val || isNaN(Number(val))) return alert('Enter physical qty (number)');
      const row = rows.find(x=>x.id===id);
      let sysQtyNum = extractNumber(row && row.qty);
      let diff = Number(val) - (sysQtyNum===null?0:sysQtyNum);
      const { error } = await supabase.from('inventory')
        .update({
          physical: val,
          difference: diff,
          checked_by: name,
          checked_at: checkedAt
        })
        .eq('id', id);
      if (error) return alert("Failed: "+error.message);
      showSuccess("Updated physical qty.");
      fetchRows();
    }
    async function bulkConfirmSelected() {
      const checkedBoxes = Array.from(document.querySelectorAll('.bulk-select:checked'));
      const checkedIds = checkedBoxes.map(cb => cb.id.replace('bulk-', ''));
      const name = document.getElementById('username').value.trim() || localStorage.getItem('inventory_user_name') || '';
      if (!checkedIds.length) return alert('Select at least one item!');
      if (!name) return alert('Enter your name first');
      const checkedAt = new Date().toISOString();
      const updates = checkedIds.map(id => {
        const inputBox = document.getElementById('qty-inp-' + id);
        let val = inputBox && inputBox.value.trim() ? inputBox.value.trim() : null;
        let row = rows.find(r => String(r.id) === id);
        let sysQtyNum = extractNumber(row ? row.qty : null);
        let newPhysical = val || row.qty;
        let newDiff = val ? Number(val) - (sysQtyNum===null?0:sysQtyNum) : 0;
        return supabase.from('inventory')
          .update({
            physical: newPhysical,
            difference: newDiff,
            checked_by: name,
            checked_at: checkedAt
          })
          .eq('id', id);
      });
      await Promise.all(updates);
      showSuccess("Bulk update done!");
      fetchRows();
    }
    function showSuccess(msg) {
      const el = document.getElementById('success-message');
      el.textContent = msg;
      if (successTimeout) clearTimeout(successTimeout);
      successTimeout = setTimeout(()=>el.textContent="", 2000);
    }
    async function exportToCSV() {
      const { data: rows, error } = await supabase.from('inventory').select('*').order('id');
      if (error || !rows || !rows.length) return alert("No data to export!");
      const header = ["id","article_name","qty","physical","difference","checked_by","checked_at"];
      const csvRows = [header];
      for (let i=0; i<rows.length; ++i) {
        const r = rows[i];
        const diffFormula = `=D${i+2}-C${i+2}`;
        csvRows.push([r.id, r.article_name, r.qty, r.physical, diffFormula, r.checked_by, r.checked_at].map(v => `"${String(v??'').replace(/"/g,'""')}"`));
      }
      let csv = csvRows.map(r => r.join(',')).join('\n');
      const blob = new Blob([csv], {type: "text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "inventory_export.csv";
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    supabase
      .channel('public:inventory')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'inventory' }, payload=>{fetchRows();})
      .subscribe();

    fetchRows();
  </script>
</body>
</html>
