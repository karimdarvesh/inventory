<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Supabase Inventory Real-time & Filterable Export</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #06101d; color: #e6eef6; }
    .container { max-width: 820px; margin: 40px auto; padding: 26px 34px 38px 34px; background: #182336; border-radius: 17px; box-shadow: 0 6px 40px #13234866;}
    header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;}
    .app-title { font-size: 2.1rem; font-weight: 700; letter-spacing: 1px;}
    .export-btn { background: #2f46c5; color: #fff; font-weight:600; padding:10px 22px; border-radius:10px; border:none; margin-left:15px; box-shadow:0 2px 8px #0002; transition:background .18s;}
    .export-btn:hover { background: #1c267b; }
    form#searchform { display: flex; align-items: center; gap: 14px; margin-bottom: 24px; }
    input#search { width:280px; border-radius: 7px; border: none; font-size:17px; padding: 10px 13px; }
    input#username {width:150px; border-radius: 7px; border: none; font-size:16px; padding:9px;}
    button, input { outline: none;}
    button { background:#10b981; color: #021; font-weight: 600; border-radius: 7px; border: none; padding:10px 22px; transition: background .18s;}
    button:hover { filter: brightness(.97);}
    button[type="button"], button[type="submit"] { margin-right:2px;}
    .voice-btn { background:#3b82f6 !important; color:#fff !important; font-size:20px; }
    .modal { display:none; position:fixed; left:0; top:0; right:0; bottom:0; background:rgba(13,16,40,0.8); z-index:99;}
    .modal-inner { max-width:600px; margin:60px auto; background: #23376a; border-radius:22px; box-shadow:0 8px 28px #0009; padding:33px 18px 28px 18px; max-height:84vh; overflow-y:auto;}
    #modal-list {margin-bottom:23px;max-height:65vh;overflow-y:auto;}
    .modal-row { background: #0b1531; border-radius:13px; box-shadow:0 2px 11px #0003; margin-bottom:20px; padding: 23px 14px;}
    .modal-row:last-child { margin-bottom:0;}
    .qty-badge, .physical-badge, .diff-badge { display:inline-block; margin-right:10px;}
    .qty-badge { background:#3b82f6; color:#fff; padding:2px 16px; border-radius:9px; font-weight:700;}
    .physical-badge { background:#10b981; color:#021; padding:2px 16px; border-radius:9px; font-weight:700;}
    .diff-badge { background:#ef4444; color:#fff; padding:2px 16px; border-radius:9px; font-weight:700;}
    .modal-row label { font-size:15px; margin-right:5px;}
    .modal-row input.qty-inp { width:80px; font-size:17px; border-radius:7px; padding:7px;}
    .modal-row .row-btn { padding:7px 18px; margin-right:6px;}
    .modal-row .voice-btn { font-size:19px; padding:7px 10px;}
    .close-btn { background: #314869; color: #bdc3cf; font-weight:700; float:right; border-radius:9px; margin-top:6px;}
    #export-range {margin-left:18px; color:#f5b042; font-size:15px;}
    @media (max-width:660px) {
      .container {padding:6px 3vw;}
      .modal-inner {max-width:99vw;}
      header, form#searchform {flex-direction:column; gap:10px;}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <span class="app-title">Inventory Manager</span>
      <button class="export-btn" onclick="exportToCSV()">Export Sheet as CSV</button>
      <span id="export-range">Export: <span id="export-info">All</span></span>
    </header>
    <form id="searchform" onsubmit="searchInventory(); return false;">
      <input id="search" placeholder="Article name or part..." autocomplete="off">
      <button type="submit">Search</button>
      <button type="button" class="voice-btn" onclick="voiceSearch()">ðŸŽ¤</button>
      <label for="username">Your Name:</label>
      <input id="username" type="text" autocomplete="off" placeholder="Enter once">
    </form>

    <!-- Modal for search results -->
    <div class="modal" id="modal-results">
      <div class="modal-inner">
        <h3 style="margin-top:0;font-weight:600;letter-spacing:0.5px;">Search Results</h3>
        <div id="modal-list"></div>
        <button class="close-btn" onclick="closeModal()" style="margin-top:11px;">Close</button>
      </div>
    </div>
  </div>
  <script>
    const SUPABASE_URL = 'https://yyzakmmxeqxkjbbzjoua.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5emFrbW14ZXF4a2piYnpqb3VhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwODg5NjYsImV4cCI6MjA3ODY2NDk2Nn0.9zs9A7F955gRsSfN-A8hTziMbQ6WEY0YwtVByq12zRQ';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentRows = [];

    document.getElementById('username').value = localStorage.getItem('inventory_user_name') || '';
    document.getElementById('username').onchange = function() {
      localStorage.setItem('inventory_user_name', this.value.trim());
    }
    function getName() {
      const box = document.getElementById('username');
      let v = box.value.trim();
      if (!v) v = localStorage.getItem('inventory_user_name') || "";
      box.value = v;
      return v;
    }
    async function searchInventory() {
      const q = document.getElementById('search').value.trim();
      let query = supabase.from('inventory').select('*');
      if (q.length) query = query.ilike('article_name', `%${q}%`);
      const { data: items, error } = await query.order('id');
      if (error) return alert(error.message);
      currentRows = items || [];
      updateExportInfo();
      showModal(currentRows);
    }
    function updateExportInfo() {
      const el = document.getElementById('export-info');
      if (!currentRows.length || currentRows.length === totalInventoryRows) el.textContent = "All";
      else el.textContent = `Filtered (${currentRows.length})`;
    }
    async function loadAllInventory() {
      const { data: items, error } = await supabase.from('inventory').select('*').order('id');
      if (!error) currentRows = items || [];
      updateExportInfo();
    }
    function voiceSearch() {
      if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
        alert('Voice input not supported!');
        return;
      }
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recog = new SR();
      recog.lang = 'en-US';
      recog.interimResults = false; recog.maxAlternatives=1;
      recog.onresult = async evt => {
        const t = String(evt.results[0][0].transcript||'').trim();
        document.getElementById('search').value = t;
        await searchInventory();
      };
      recog.onerror = e => { alert('Voice error: '+e.error); };
      recog.start();
    }
    function showModal(items) {
      const modal = document.getElementById('modal-results');
      const mlist = document.getElementById('modal-list');
      if (!items.length) { mlist.innerHTML = '<b>No matches found.</b>'; modal.style.display = 'block'; return; }
      mlist.innerHTML = items.map((item,i)=>{
        // REVISED difference calculation logic (never NaN)
        let qtyRaw = item.qty, physicalRaw = item.physical;
        let qtyNum = (!qtyRaw || isNaN(Number(qtyRaw))) ? 0 : Number(qtyRaw);
        let physicalNum = (!physicalRaw || isNaN(Number(physicalRaw))) ? 0 : Number(physicalRaw);
        let diffStr = '-';
        if (qtyRaw !== undefined && qtyRaw !== '' && physicalRaw !== undefined && physicalRaw !== '' && !isNaN(qtyNum) && !isNaN(physicalNum)) {
          diffStr = (physicalNum - qtyNum).toString();
        }
        return `
        <div class="modal-row" id="modal-row-${item.id}">
          <b style="font-size:1.05em;">${item.article_name}</b><br>
          <span class="qty-badge">System: ${qtyRaw === undefined || qtyRaw === "" ? '-' : qtyRaw}</span>
          <span class="physical-badge">Physical: ${physicalRaw === undefined || physicalRaw === "" ? '-' : physicalRaw}</span>
          <span class="diff-badge">Difference: ${diffStr}</span>
          <div style="margin-top:10px;">
            <button class="row-btn" onclick="markOK(${item.id}, '${qtyRaw}', ${i})">OK</button>
            <label>Or enter:</label>
            <input class="qty-inp" id="qty-inp-${item.id}" placeholder="Physical qty">
            <button class="voice-btn" onclick="voiceQty(${item.id})" title="Voice input">ðŸŽ¤</button>
            <button class="row-btn" style="background:#3b82f6;color:#fff;" onclick="updateQty(${item.id}, ${i})">Update</button>
          </div>
          <span style="font-size:13px;color:#ffa;">Checked By: ${item.checked_by||'-'} | Checked At: ${item.checked_at||'-'}</span>
        </div>
      `}).join('');
      modal.style.display = 'block';
    }
    function closeModal() { document.getElementById('modal-results').style.display = 'none'; }
    async function markOK(id, qtyValue, idx) {
      const name = getName();
      if (!name) { alert('Enter your name first'); return; }
      const checkedAt = new Date().toISOString();
      const { error: updateErr } = await supabase.from('inventory')
        .update({ 
          physical: qtyValue, 
          difference: 0, 
          checked_by: name, 
          checked_at: checkedAt 
        })
        .eq('id', id);
      if (updateErr) {
        alert('Failed to update: ' + updateErr.message);
        return;
      }
      markDoneRow(id, `Physical set to ${qtyValue}, Difference: 0`);
      setTimeout(() => { closeModal(); }, 700); // <-- Only close modal, no auto search
    }
    async function updateQty(id, idx) {
      const name = getName();
      if (!name) { alert('Enter your name first'); return; }
      const checkedAt = new Date().toISOString();
      const val = document.getElementById('qty-inp-'+id).value.trim();
      if (!val || isNaN(Number(val))) { alert('Enter physical qty (number)'); return; }
      const { data, error } = await supabase.from('inventory').select('qty').eq('id', id);
      let sysQtyRaw = data && data.length ? data[0].qty : 0;
      let sysQty = (!sysQtyRaw || isNaN(Number(sysQtyRaw))) ? 0 : Number(sysQtyRaw);
      let diff = Number(val) - sysQty;
      const { error: updateErr } = await supabase.from('inventory')
        .update({
          physical: val,
          difference: diff,
          checked_by: name,
          checked_at: checkedAt
        })
        .eq('id', id);
      if (updateErr) {
        alert('Failed to update: ' + updateErr.message);
        return;
      }
      markDoneRow(id, `Physical: ${val}, Difference: ${diff}`);
      setTimeout(() => { closeModal(); }, 700); // <-- Only close modal, no auto search
    }
    function voiceQty(id) {
      if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
        alert('Voice input not supported!');
        return;
      }
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recog = new SR();
      recog.lang = 'en-US';
      recog.interimResults = false; recog.maxAlternatives=1;
      recog.onresult = evt => {
        const t = String(evt.results[0][0].transcript||'').trim();
        document.getElementById('qty-inp-'+id).value = t;
      };
      recog.onerror = e => { alert('Voice error: '+e.error); };
      recog.start();
    }
    function markDoneRow(id, msg) {
      const row = document.getElementById('modal-row-'+id);
      if (row) row.innerHTML += `<div style="color:#10b981;font-weight:bold;margin-top:7px;">${msg}</div>`;
      setTimeout(()=>{ if(row) row.style.opacity=0.4; }, 700);
    }
    // Export filtered/in-view data to CSV with Excel formula
    async function exportToCSV() {
      let rows = currentRows.length ? currentRows : await supabase.from('inventory').select('*').order('id').then(r => r.data || []);
      if (!rows || !rows.length) return alert("No data to export!");
      // Sort by id for Excel consistency
      rows = rows.slice().sort((a,b) => (a.id-b.id));
      const cols = ['id','article_name','qty','physical','difference','checked_by','checked_at'];
      const header = cols;
      const csvRows = [header];
      for (let i=0; i<rows.length; ++i) {
        const r = rows[i];
        // Excel formula: physical - qty (Excel columns C and D)
        const diffFormula = `=C${i+2}-D${i+2}`;
        csvRows.push([r.id, r.article_name, r.qty, r.physical, diffFormula, r.checked_by, r.checked_at].map(v => `"${String(v??'').replace(/"/g,'""')}"`));
      }
      let csv = csvRows.map(r => r.join(',')).join('\n');
      const blob = new Blob([csv], {type: "text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "inventory_export.csv";
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Real-time sync for inventory table (any change triggers searchInventory)
    supabase
      .channel('public:inventory')
      .on(
        'postgres_changes',
        { event: '*', schema: 'public', table: 'inventory' },
        payload => {
          // Data is reloaded if changes occur in inventory table
        }
      )
      .subscribe();

    // Load all for initial export info display (optional)
    let totalInventoryRows = 0;
    (async function(){ 
      const {data} = await supabase.from('inventory').select('*');
      totalInventoryRows = data ? data.length : 0;
      currentRows = data || [];
      updateExportInfo();
    })();
  </script>
</body>
</html>
