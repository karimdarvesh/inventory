<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Supabase Inventory Manager</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f7fafd; color: #21243a; margin:0; }
    .container { max-width: 900px; margin: 38px auto; padding: 22px 2vw; background:#fff; border-radius:15px; box-shadow:0 6px 40px #e4ecfc99;}
    .app-title { font-size: 2.17rem; font-weight: 700; color: #224198;}
    .export-btn { background: #1ea7b5; color:#fff; font-weight:700; padding:9px 20px; border-radius:10px; border:none; font-size:1.03rem; float:right; margin-left:12px;}
    .export-btn:hover { background: #15777f;}
    .action-btn { background:#3275f5; color: #fff; font-weight: 700; border-radius: 11px; padding: 12px 20px; border: none; margin: 10px 0 18px 0; font-size: 1.06rem; box-shadow:0 1px 8px #b7e8ff46;}
    .action-btn:hover { background:#1c4ca0;}
    .inv-table {width:100%;border-collapse:collapse;margin-top:16px;}
    th, td {padding:8px 6px;text-align:center;border-bottom:1px solid #e6f3fb;}
    th {background:#f6fafd; font-weight:700; letter-spacing:.2px;}
    tr:last-child td {border-bottom: none;}
    .qty-badge { background:#b9e7fa; color:#22577e; padding:2px 10px; border-radius:7px; font-weight:700;}
    .physical-badge { background:#d7fce6; color:#206648; padding:2px 10px; border-radius:7px; font-weight:700;}
    .diff-badge { background:#ffe9b4; color:#b98500; padding:2px 10px; border-radius:7px; font-weight:700;}
    .diff-badge.negative { background:#ff6f6f; color:#fff; }
    .diff-badge.positive { background:#17c47d; color:#fff; }
    /* Modal */
    .modal { display:none; position:fixed; left:0; top:0; right:0; bottom:0; background:rgba(13,16,40,0.13); z-index:99;}
    .modal-inner { max-width:620px; margin:60px auto; background: #fff; border-radius:19px; box-shadow:0 7px 36px #b1c0d821; padding:22px 2vw 22px 2vw; max-height:89vh; overflow-y:auto; position:relative; }
    .close-btn { display: block; width: 100%; background: #4eadcc; color: #fff; font-weight: 700; border-radius: 12px; padding: 15px 0; margin: 20px auto 0 auto; box-shadow: 0 1px 10px #c2fdf8; border: none; font-size: 1rem; cursor: pointer; text-align: center;}
    .close-btn:hover { background:#15777f;}
    .modal-row {
      background: #f4f9ff;
      border-radius:13px;
      box-shadow:0 2px 11px #accedc18;
      margin-bottom:18px;
      padding: 18px 9px;
      border-left:5px solid #86cafe;
      border-right:3px solid #c2f7fa;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }
    .modal-row-content { flex: 1; }
    .qty-badge, .physical-badge, .diff-badge {
      display:inline-block;
      margin-right:10px;
      font-size: 97%;
      letter-spacing:.4px;
      margin-bottom:6px;
    }
    .qty-badge { background:#b9e7fa; color:#22577e; padding:3px 16px; border-radius:8px; font-weight:700;}
    .physical-badge { background:#d7fce6; color:#206648; padding:3px 16px; border-radius:8px; font-weight:700;}
    .diff-badge { background:#ffe9b4; color:#b98500; padding:3px 16px; border-radius:8px; font-weight:700;}
    .diff-badge.negative { background:#ff6f6f; color:#fff; }
    .diff-badge.positive { background:#17c47d; color:#fff; }
    .modal-row label { font-size:15px; margin-right:4px;}
    .modal-row input.qty-inp { width:88px; font-size:15px; border-radius:7px; padding:6px 6px; border:1.2px solid #d0def5; background:#fcfeff;}
    .modal-row .row-btn { padding:6px 13px; margin-right:6px; font-size:1em; background:linear-gradient(90deg,#4eadcc,#67e8f9); color:#fff; }
    .modal-row .row-btn:hover {background:linear-gradient(90deg,#67e8f9,#be70f5);}
    .modal-row .voice-btn { font-size:17px; padding:6px 9px;}
    .bulk-select { margin-top: 6px; margin-right: 3px; transform: scale(1.18); }
    .bulk-update-btn {
      display: block;
      width: 100%;
      background: #4eadcc;
      color: #fff;
      font-weight: 700;
      border-radius: 12px;
      padding: 16px 0;
      margin: 18px auto 0 auto;
      box-shadow: 0 1px 10px #c2fdf8;
      border: none;
      font-size: 1rem;
      cursor: pointer;
      text-align: center;
    }
    .bulk-update-btn:hover{background:#43ad97;}
    @media (max-width:600px) {
      .container { padding: 7px 0vw;}
      th,td { font-size:.92em;}
      .modal-inner {padding:8px 1vw;}
      .modal-row { padding: 12px 4px;}
      .close-btn, .bulk-update-btn { font-size: 1.15rem; padding: 22px 0;}
      .searchbar-row { flex-wrap: wrap; gap: 7px;}
      .searchbox { min-width:90px; }
      .namebox, .search-label { min-width:80px; }
    }
    .searchbar-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 9px 12px;
      background: #f4f7fe;
      border-radius: 14px;
      box-shadow: 0 2px 12px #d4e6fa26;
      margin-bottom: 4px;
      transition: box-shadow 0.2s;
    }
    .search-icon {
      font-size: 1.45em;
      margin-right: -4px;
      color: #4685c3;
    }
    .searchbox {
      flex: 2;
      padding: 9px 38px 9px 32px;
      font-size: 1.11em;
      border: 1.5px solid #c3e1fa;
      border-radius: 8px;
      background: #fcfdff;
      transition: border-color 0.2s;
      box-shadow: 0 1px 4px #d7eaf866;
    }
    .searchbox:focus {
      border-color: #2684ff;
      outline: none;
    }
    .search-btn, .voice-btn.modern-voice {
      background:linear-gradient(90deg,#3275f5 60%,#67e8f9 100%);
      color:#fff;
      border:none;
      font-size:1.1em;
      font-weight:600;
      border-radius:9px;
      padding:9px 23px;
      margin-left:2px;
      cursor:pointer;
      transition: background 0.2s, box-shadow 0.2s;
      box-shadow: 0 1px 10px #c2fdf8;
    }
    .search-btn:hover, .voice-btn.modern-voice:hover {
      background:linear-gradient(90deg,#67e8f9 20%,#152abb 98%);
      box-shadow: 0 2px 15px #93d8fa52;
    }
    .voice-btn.modern-voice {
      padding:9px 11px;
      font-size: 1.25em;
    }
    .namebox {
      padding: 9px 13px;
      font-size: 1em;
      border: 1.5px solid #e1eee9;
      border-radius: 8px;
      background: #fcfdff;
      min-width:140px;
      max-width:180px;
      margin-left:7px;
    }
    .search-label {
      font-size: 1em;
      margin-left:9px;
      color: #39658f;
    }
    /* Animated SVG X close */
    .modal-close-xbtn {
      position: absolute;
      top: 17px;
      right: 19px;
      background: none;
      border: none;
      padding: 0;
      cursor: pointer;
      z-index: 101;
      border-radius: 50%;
      transition: background 0.2s;
    }
    .modal-close-xbtn:hover, .modal-close-xbtn:focus {
      background: #eaf2fb;
      outline: none;
    }
    .modal-close-xsvg {
      display: block;
      width: 2.4em;
      height: 2.4em;
      stroke: #6797ba;
      stroke-width: 2.2;
      stroke-linecap: round;
      fill: none;
      transition:
        transform 0.22s cubic-bezier(.38,.2,.11,.91),
        stroke 0.22s cubic-bezier(.38,.2,.11,.91);
    }
    .modal-close-xbtn:hover .modal-close-xsvg {
      stroke: #2764ae;
      transform: rotate(120deg) scale(0.95);
    }
    .modal-close-xbtn:active .modal-close-xsvg {
      transform: scale(0.9);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <span class="app-title">Supabase Inventory Manager</span>
      <button class="export-btn" onclick="exportToCSV()">Export Sheet as CSV</button>
    </header>
    <!-- Modernized search bar at the top -->
    <form id="searchform" onsubmit="searchInventory(); return false;" style="margin-top:18px; margin-bottom:18px;">
      <div class="searchbar-row">
        <span class="search-icon">üîç</span>
        <input id="search" class="searchbox" placeholder="Search article or part..." autocomplete="off">
        <button type="submit" class="search-btn">Search</button>
        <button type="button" class="voice-btn modern-voice" onclick="voiceSearch()" title="Voice Search"><span>üé§</span></button>
        <label for="username" class="search-label">Your Name:</label>
        <input id="username" class="namebox" type="text" autocomplete="off" placeholder="Enter once">
      </div>
    </form>
    <!-- LIVE dashboard showing only items with nonzero difference -->
    <h4 style="margin-top:10px;">Articles With Difference ‚â† 0 (Action Needed)</h4>
    <table class="inv-table">
      <thead>
        <tr>
          <th>Article Name</th>
          <th>System</th>
          <th>Physical</th>
          <th>Difference</th>
        </tr>
      </thead>
      <tbody id="dashboard-tbody"></tbody>
    </table>
    <!-- Modal for search results -->
    <div class="modal" id="modal-results">
      <div class="modal-inner">
        <!-- Animated SVG Close Button -->
        <button class="modal-close-xbtn" onclick="closeModal()" aria-label="Close">
          <svg viewBox="0 0 32 32" class="modal-close-xsvg">
            <line x1="11" y1="11" x2="21" y2="21"/>
            <line x1="21" y1="11" x2="11" y2="21"/>
          </svg>
        </button>
        <h3 style="margin-top:0;font-weight:600;letter-spacing:0.5px;">Search Results</h3>
        <div id="modal-list"></div>
        <button class="bulk-update-btn" onclick="bulkConfirmSelected()">Confirm/Update Selected</button>
        <button class="close-btn" onclick="closeModal()">Close</button>
      </div>
    </div>
  </div>
  <script>
    const SUPABASE_URL = 'https://yyzakmmxeqxkjbbzjoua.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5emFrbW14ZXF4a2piYnpqb3VhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwODg5NjYsImV4cCI6MjA3ODY2NDk2Nn0.9zs9A7F955gRsSfN-A8hTziMbQ6WEY0YwtVByq12zRQ';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentRows = [];
    document.getElementById('username').value = localStorage.getItem('inventory_user_name') || '';
    document.getElementById('username').onchange = function() {
      localStorage.setItem('inventory_user_name', this.value.trim());
    }
    function getName() {
      const box = document.getElementById('username');
      let v = box.value.trim();
      if (!v) v = localStorage.getItem('inventory_user_name') || "";
      box.value = v;
      return v;
    }
    function extractNumber(val) {
      if (val === undefined || val === null) return null;
      let s = String(val);
      let match = s.match(/-?\d+(\.\d+)?/);
      return match ? Number(match[0]) : null;
    }

    // --- DASHBOARD LOGIC ---
    async function renderDashboard() {
      const { data, error } = await supabase.from('inventory').select('*').order('id');
      const tbody = document.getElementById('dashboard-tbody');
      if (error) {
        tbody.innerHTML = '<tr><td colspan="4">Failed to load</td></tr>'; return;
      }
      // Show only records where both qty and physical are valid numbers and difference is NOT zero
      const diffItems = (data || []).filter(item => {
        let qtyNum = extractNumber(item.qty);
        let physNum = extractNumber(item.physical);
        if (
          qtyNum !== null &&
          physNum !== null &&
          !isNaN(qtyNum) &&
          !isNaN(physNum)
        ) {
          const diff = physNum - qtyNum;
          return diff !== 0;
        }
        return false;
      });

      if (!diffItems.length) {
        tbody.innerHTML = '<tr><td colspan="4">No articles with difference below or above zero!</td></tr>'; return;
      }

      tbody.innerHTML = diffItems.map(item => {
        let qtyDisp = (item.qty===undefined||item.qty===null||item.qty===""||item.qty==="null") ? '-' : item.qty;
        let physDisp = (item.physical===undefined||item.physical===null||item.physical===""||item.physical==="null") ? '-' : item.physical;
        let qtyNum = extractNumber(item.qty);
        let physNum = extractNumber(item.physical);
        let diffVal = physNum - qtyNum;
        let diffStr = !isNaN(diffVal) ? diffVal : '-';
        let diffClass = "";
        if (!isNaN(diffVal)) {
          if (diffVal < 0) diffClass = "negative";
          else if (diffVal > 0) diffClass = "positive";
        }
        return `<tr>
          <td>${item.article_name||""}</td>
          <td><span class="qty-badge">${qtyDisp}</span></td>
          <td><span class="physical-badge">${physDisp}</span></td>
          <td><span class="diff-badge ${diffClass}">${diffStr}</span></td>
        </tr>`;
      }).join('');
    }

    function closeModal() { document.getElementById('modal-results').style.display = 'none'; }

    function voiceSearch() {
      if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
        alert('Voice input not supported!');
        return;
      }
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recog = new SR();
      recog.lang = 'en-US';
      recog.interimResults = false; recog.maxAlternatives=1;
      recog.onresult = async evt => {
        const t = String(evt.results[0][0].transcript||'').trim();
        document.getElementById('search').value = t;
        await searchInventory();
      };
      recog.onerror = e => { alert('Voice error: '+e.error); };
      recog.start();
    }

    async function searchInventory() {
      const q = document.getElementById('search').value.trim();
      let query = supabase.from('inventory').select('*');
      if (q.length) query = query.ilike('article_name', `%${q}%`);
      const { data: items, error } = await query.order('id');
      if (error) return alert(error.message);
      currentRows = items || [];
      showModal(currentRows);
    }

    function showModal(items) {
      const modal = document.getElementById('modal-results');
      const mlist = document.getElementById('modal-list');
      if (!items.length) { mlist.innerHTML = '<b>No matches found.</b>'; modal.style.display = 'block'; return; }
      mlist.innerHTML = items.map((item,i)=>{
        let qtyNum = extractNumber(item.qty);
        let physicalNum = extractNumber(item.physical);
        let qtyDisplay = (qtyNum === null || item.qty == null || item.qty === "" || item.qty === "null") ? '-' : item.qty;
        let physicalDisplay = (physicalNum === null || item.physical == null || item.physical === "" || item.physical === "null") ? '-' : item.physical;
        let diffStr = '-';
        let diffClass = "";
        if (qtyNum !== null && physicalNum !== null && !isNaN(qtyNum) && !isNaN(physicalNum)) {
          let diff = physicalNum - qtyNum;
          diffStr = diff.toString();
          if (diff<0) diffClass = "negative";
          else if (diff>0) diffClass = "positive";
        }
        return `
          <div class="modal-row" id="modal-row-${item.id}">
            <input type="checkbox" class="bulk-select" id="bulk-${item.id}">
            <div class="modal-row-content">
              <b style="font-size:1.05em;">${item.article_name}</b><br>
              <span class="qty-badge">System: ${qtyDisplay}</span>
              <span class="physical-badge">Physical: ${physicalDisplay}</span>
              <span class="diff-badge ${diffClass}">Difference: ${diffStr}</span>
              <div style="margin-top:10px;">
                <button class="row-btn" onclick="markOK(${item.id}, '${qtyDisplay}', ${i})">OK</button>
                <label>Or enter:</label>
                <input class="qty-inp" id="qty-inp-${item.id}" placeholder="Physical qty">
                <button class="voice-btn" onclick="voiceQty(${item.id})" title="Voice input">üé§</button>
                <button class="row-btn" onclick="updateQty(${item.id}, ${i})">Update</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
      modal.style.display = 'block';
    }

    async function markOK(id, qtyValue, idx) {
      const name = getName();
      if (!name) { alert('Enter your name first'); return; }
      const checkedAt = new Date().toISOString();
      const { error: updateErr } = await supabase.from('inventory')
        .update({ 
          physical: qtyValue, 
          difference: 0, 
          checked_by: name, 
          checked_at: checkedAt 
        })
        .eq('id', id);
      if (updateErr) {
        alert('Failed to update: ' + updateErr.message);
        return;
      }
      markDoneRow(id, `Physical set to ${qtyValue}, Difference: 0`);
      setTimeout(() => { closeModal(); renderDashboard(); }, 700);
    }

    async function updateQty(id, idx) {
      const name = getName();
      if (!name) { alert('Enter your name first'); return; }
      const checkedAt = new Date().toISOString();
      const val = document.getElementById('qty-inp-'+id).value.trim();
      if (!val || isNaN(Number(val))) { alert('Enter physical qty (number)'); return; }
      const { data, error } = await supabase.from('inventory').select('qty').eq('id', id);
      let sysQtyRaw = data && data.length ? data[0].qty : 0;
      let sysQty = extractNumber(sysQtyRaw);
      let diff = Number(val) - (sysQty === null ? 0 : sysQty);
      const { error: updateErr } = await supabase.from('inventory')
        .update({
          physical: val,
          difference: diff,
          checked_by: name,
          checked_at: checkedAt
        })
        .eq('id', id);
      if (updateErr) {
        alert('Failed to update: ' + updateErr.message);
        return;
      }
      markDoneRow(id, `Physical: ${val}, Difference: ${diff}`);
      setTimeout(() => { closeModal(); renderDashboard(); }, 700);
    }

    async function bulkConfirmSelected() {
      const checkedBoxes = Array.from(document.querySelectorAll('.bulk-select:checked'));
      const checkedIds = checkedBoxes.map(cb => cb.id.replace('bulk-', ''));
      const name = getName();
      if (!checkedIds.length) return alert('Select at least one item!');
      const checkedAt = new Date().toISOString();
      const updates = checkedIds.map(id => {
        const inputBox = document.getElementById('qty-inp-' + id);
        let val = inputBox && inputBox.value.trim() ? inputBox.value.trim() : null;
        let row = currentRows.find(r => String(r.id) === id);
        let sysQtyRaw = row ? row.qty : null;
        let sysQty = extractNumber(sysQtyRaw);
        let newPhysical = val || sysQtyRaw;
        let newDiff = val ? Number(val) - (sysQty === null ? 0 : sysQty) : 0;
        return supabase.from('inventory')
          .update({
            physical: newPhysical,
            difference: newDiff,
            checked_by: name,
            checked_at: checkedAt
          })
          .eq('id', id);
      });
      await Promise.all(updates);
      closeModal(); renderDashboard();
    }

    function voiceQty(id) {
      if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
        alert('Voice input not supported!');
        return;
      }
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recog = new SR();
      recog.lang = 'en-US';
      recog.interimResults = false; recog.maxAlternatives=1;
      recog.onresult = evt => {
        const t = String(evt.results[0][0].transcript||'').trim();
        document.getElementById('qty-inp-'+id).value = t;
      };
      recog.onerror = e => { alert('Voice error: '+e.error); };
      recog.start();
    }

    function markDoneRow(id, msg) {
      const row = document.getElementById('modal-row-'+id);
      if (row) row.innerHTML += `<div style="color:#43ad97;font-weight:bold;margin-top:7px;">${msg}</div>`;
      setTimeout(()=>{ if(row) row.style.opacity=0.5; }, 700);
    }

    async function exportToCSV() {
      const { data: rows, error } = await supabase.from('inventory').select('*').order('id');
      if (error || !rows || !rows.length) return alert("No data to export!");
      const header = ["id","article_name","qty","physical","difference","checked_by","checked_at"];
      const csvRows = [header];
      for (let i=0; i<rows.length; ++i) {
        const r = rows[i];
        const diffFormula = `=D${i+2}-C${i+2}`;
        csvRows.push([r.id, r.article_name, r.qty, r.physical, diffFormula, r.checked_by, r.checked_at].map(v => `"${String(v??'').replace(/"/g,'""')}"`));
      }
      let csv = csvRows.map(r => r.join(',')).join('\n');
      const blob = new Blob([csv], {type: "text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "inventory_export.csv";
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    supabase
      .channel('public:inventory')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'inventory' }, payload=>{ renderDashboard(); })
      .subscribe();
    renderDashboard();
  </script>
</body>
</html>
