<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>SeaTable Inventory Manager</title>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #06101d; color: #e6eef6; }
    .container { max-width: 820px; margin: 40px auto; padding: 26px 34px 38px 34px; background: #182336; border-radius: 17px; box-shadow: 0 6px 40px #13234866; }
    header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;}
    .app-title { font-size: 2.1rem; font-weight: 700; }
    .export-btn { background: #2f46c5; color: white; font-weight: 600; padding:10px 22px; border-radius: 10px; border: none; cursor: pointer; }
    form#searchform { display: flex; align-items: center; gap: 14px; margin-bottom: 24px; }
    input#search, input#username { border-radius: 7px; border: none; font-size: 16px; padding: 9px; }
    input#search { width: 280px; }
    input#username { width: 150px; }
    button, input { outline: none; }
    button { background: #10b981; color: #021; font-weight: 600; border-radius: 7px; border: none; padding: 10px 22px; }
    button:hover { filter: brightness(0.95); cursor: pointer;}
    button.voice-btn { background: #3b82f6 !important; color: #fff !important; font-size: 20px; }
    .modal { display: none; position: fixed; left: 0; top: 0; right: 0; bottom: 0; background: rgba(13,16,40,0.8); z-index: 99; overflow-y:auto; }
    .modal-inner { max-width: 600px; margin: 60px auto; background: #23376a; border-radius: 22px; box-shadow: 0 8px 28px #0009; padding: 33px 18px 28px 18px; max-height: 80vh; overflow-y: auto; }
    #modal-list { margin-bottom: 23px; }
    .modal-row { background: #0b1531; border-radius: 13px; box-shadow: 0 2px 11px #0003; margin-bottom: 20px; padding: 23px 14px; }
    .modal-row b { font-size: 1.05em; }
    .qty-badge, .depo-badge, .diff-badge { display: inline-block; margin-right: 10px; padding: 2px 16px; border-radius: 9px; font-weight: 700; }
    .qty-badge { background: #3b82f6; color: #fff; }
    .depo-badge { background: #10b981; color: #021; }
    .diff-badge { background: #ef4444; color: #fff; }
    .modal-row label { font-size: 15px; margin-right: 5px; }
    .modal-row input.qty-inp { width: 90px; font-size: 17px; border-radius: 7px; padding: 7px; }
    .modal-row .row-btn { padding: 7px 18px; margin-right: 6px; }
    .modal-row .voice-btn { font-size: 19px; padding: 7px 10px; }
    .close-btn { background: #314869; color: #bdc3cf; font-weight: 700; float: right; border-radius: 9px; margin-top: 6px; padding: 6px 20px; cursor: pointer; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <span class="app-title">SeaTable Inventory Manager</span>
    </header>
    <form id="searchform" onsubmit="searchInventory();return false;">
      <input id="search" placeholder="Search by Name..." autocomplete="off" />
      <button type="submit">Search</button>
      <label>Your Name:</label>
      <input id="username" placeholder="Enter your name" autocomplete="off" />
    </form>

    <div id="results"></div>

    <div class="modal" id="modal-results">
      <div class="modal-inner">
        <h3>Search Results</h3>
        <div id="modal-list"></div>
        <button class="close-btn" onclick="closeModal()">Close</button>
      </div>
    </div>
  </div>

  <script>
    const SERVER_URL = 'https://cloud.seatable.io';
    const API_TOKEN = 'a081ffcb77d0ed598cc016a1cc8caf9fbb35322b';
    const TABLE_NAME = 'WH';
    let ACCESS_TOKEN = '';
    let DTABLE_UUID = '';
    let currentRows = [];

    document.getElementById('username').value = localStorage.getItem('inventory_user_name') || '';
    document.getElementById('username').addEventListener('input', () => {
      localStorage.setItem('inventory_user_name', document.getElementById('username').value.trim());
    });

    async function getAccessToken() {
      if (ACCESS_TOKEN && DTABLE_UUID) return;
      const res = await fetch(`${SERVER_URL}/api/v2.1/dtable/app-access-token/`, {
        method: 'GET',
        headers: { 'Authorization': `Token ${API_TOKEN}` }
      });
      const json = await res.json();
      ACCESS_TOKEN = json.access_token;
      DTABLE_UUID = json.dtable_uuid;
    }

    async function fetchRows(searchTerm='') {
      await getAccessToken();
      let url = `${SERVER_URL}/api/v2.1/dtables/${DTABLE_UUID}/rows/?table_name=${TABLE_NAME}`;
      if (searchTerm.trim()) url += `&row_keyword=${encodeURIComponent(searchTerm.trim())}`;
      const res = await fetch(url, { headers: { 'Authorization': `Bearer ${ACCESS_TOKEN}` } });
      const json = await res.json();
      return json.rows || [];
    }

    async function searchInventory() {
      const searchTerm = document.getElementById('search').value;
      currentRows = await fetchRows(searchTerm);
      showModal(currentRows);
    }

    function showModal(rows) {
      const modal = document.getElementById('modal-results');
      const list = document.getElementById('modal-list');
      if (!rows.length) {
        list.innerHTML = '<b>No results found</b>';
        modal.style.display = 'block';
        return;
      }
      list.innerHTML = rows.map(row => {
        const qty = parseFloat(row.Tally) || 0;
        const depo = row.Depo || '';
        const diff = parseFloat(depo) - qty;
        return `
          <div class="modal-row" id="row-${row._id}">
            <b>${row.Name}</b><br />
            <span class="qty-badge">Tally: ${qty}</span>
            <span class="depo-badge">Depo: ${depo}</span>
            <span class="diff-badge">Diff: ${isNaN(diff) ? '-' : diff}</span>
            <div style="margin-top: 10px;">
              <button class="row-btn" onclick="markOK('${row._id}', ${qty})">OK</button>
              <label>Or enter:</label>
              <input class="qty-inp" id="input-${row._id}" type="number" placeholder="Physical qty" />
              <button class="voice-btn" onclick="voiceQty('${row._id}')">ðŸŽ¤</button>
              <button class="row-btn" onclick="updateDepo('${row._id}')">Update</button>
            </div>
          </div>
        `;
      }).join('');
      modal.style.display = 'block';
    }

    function closeModal() {
      document.getElementById('modal-results').style.display = 'none';
    }

    async function markOK(rowId, qty) {
      await getAccessToken();
      const checkedBy = document.getElementById('username').value.trim();
      if (!checkedBy) { alert('Please enter your name!'); return; }
      const rez = await fetch(`${SERVER_URL}/api/v2.1/dtables/${DTABLE_UUID}/rows/`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${ACCESS_TOKEN}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          row_id: rowId,
          table_name: TABLE_NAME,
          row: {
            Depo: qty
          }
        })
      });
      if (!rez.ok) alert('Update failed');
      closeModal();
      await refreshAfterUpdate();
    }

    async function updateDepo(rowId) {
      await getAccessToken();
      const inputBox = document.getElementById('input-' + rowId);
      let val = inputBox.value.trim();
      const checkedBy = document.getElementById('username').value.trim();
      if (!checkedBy) { alert('Please enter your name!'); return; }
      if (!val || isNaN(val)) { alert('Enter a valid number'); return; }
      val = Number(val);
      const rez = await fetch(`${SERVER_URL}/api/v2.1/dtables/${DTABLE_UUID}/rows/`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${ACCESS_TOKEN}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          row_id: rowId,
          table_name: TABLE_NAME,
          row: {
            Depo: val
          }
        })
      });
      if (!rez.ok) alert('Update failed');
      closeModal();
      await refreshAfterUpdate();
    }

    function voiceQty(rowId) {
      if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
        alert('Voice input not supported!');
        return;
      }
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recog = new SR();
      recog.lang = 'en-US';
      recog.interimResults = false;
      recog.maxAlternatives = 1;
      recog.onresult = event => {
        const transcript = String(event.results[0][0].transcript || '').trim();
        const inputBox = document.getElementById('input-' + rowId);
        if (inputBox) inputBox.value = transcript;
      };
      recog.onerror = e => { alert('Voice error: ' + e.error); };
      recog.start();
    }

    async function refreshAfterUpdate() {
      // Optionally re-fetch current search results for real-time UI update after changes
      const searchTerm = document.getElementById('search').value.trim();
      currentRows = await fetchRows(searchTerm);
      showModal(currentRows);
    }

    // Optionally run initial fetch (if you want to auto-show on page load)
    // window.onload = () => { searchInventory(); }
  </script>
</body>
</html>
